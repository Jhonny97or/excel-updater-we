<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Actualizador Inventario (OneDrive)</title>
  <!-- ✅ MSAL desde CDN correcto -->
  <script src="https://alcdn.msauth.net/browser/2.39.0/js/msal-browser.min.js"></script>
  <style>body{font-family:sans-serif;max-width:700px;margin:40px auto}</style>
</head>
<body>
  <h1>Actualizador Inventario (OneDrive)</h1>

  <!-- ——— login ——— -->
  <button id="loginBtn">Iniciar sesión</button>
  <span id="user"></span>
  <hr>

  <!-- ——— formulario de carga ——— -->
  <form id="f" style="display:none">
    Mes (YYYY-MM):
    <input name="period" required><br><br>

    Inventario XLSX:
    <input type="file" name="inv" accept=".xlsx" required><br><br>

    Ventas XLSX:
    <input type="file" name="ven" accept=".xlsx" required><br><br>

    <progress id="p" value="0" max="100" style="width:100%"></progress><br>
    <button>Procesar</button>
  </form>

  <!-- ——— script principal ——— -->
  <script type="module">
    /* 1. carga config (clientId & authority) */
    import "/api/config.js";

    if (!window.EXCEL_UP_CFG)
      throw new Error("MSAL config missing – revisa /api/config.js");

    const msal = new msaljs.PublicClientApplication({
      auth: window.EXCEL_UP_CFG
    });

    const loginBtn = document.getElementById("loginBtn");
    const form     = document.getElementById("f");
    const userSpan = document.getElementById("user");
    const prog     = document.getElementById("p");

    loginBtn.onclick = async () => {
      try {
        const r = await msal.loginPopup({
          scopes: ["Files.Read.All", "User.Read"]
        });
        loginBtn.style.display = "none";
        form.style.display = "block";
        userSpan.textContent = r.account.username;
      } catch (e) {
        alert("Login error\n" + e);
      }
    };

    /* 2. envío de archivos + barra de progreso */
    form.onsubmit = async e => {
      e.preventDefault();
      const fd = new FormData(form);

      const xhr = new XMLHttpRequest();
      xhr.open("POST", "/api/process.py");
      xhr.upload.onprogress = ev => {
        if (ev.lengthComputable) {
          prog.value = (ev.loaded / ev.total) * 100;
        }
      };
      xhr.responseType = "blob";
      xhr.onload = () => {
        if (xhr.status !== 200) {
          alert("Error: " + xhr.responseText);
          prog.value = 0;
          return;
        }
        const blob = xhr.response;
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement("a");
        a.href = url;
        a.download = `TblInventario_actualizado_${fd.get("period")}.xlsx`;
        a.click();
        URL.revokeObjectURL(url);
        prog.value = 0;
      };
      xhr.onerror = () => alert("Error de red");
      xhr.send(fd);
    };
  </script>
</body>
</html>
