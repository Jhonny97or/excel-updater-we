<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Actualizador Inventario</title>
</head>
<body>
  <h1>Actualizador Inventario (OneDrive)</h1>

  <form id="f">
    Mes (YYYY-MM): <input name="period" required /><br /><br />
    Inventario:    <input type="file" name="inv" accept=".xlsx" required /><br /><br />
    Ventas:        <input type="file" name="ven" accept=".xlsx" required /><br /><br />
    <button type="submit">Procesar</button>
  </form>

  <p id="status"></p>

  <!-- ‚ë†  Config de MSAL generada en runtime -->
  <script src="/api/config.js"></script>

  <!-- ‚ë°  MSAL desde el CDN oficial -->
  <script src="https://alcdn.msauth.net/browser/2.39.0/js/msal-browser.min.js"></script>

  <script>
    if (!window.EXCEL_UP_CFG) {
      document.getElementById("status").textContent =
        "‚ö†Ô∏è Configuraci√≥n MSAL ausente. Revisa /api/config.js.";
      throw new Error("MSAL config missing");
    }

    // Instancia MSAL
    const msal = new msal.PublicClientApplication({
      auth: {
        clientId:  window.EXCEL_UP_CFG.clientId,
        authority: window.EXCEL_UP_CFG.authority,
        redirectUri: window.location.origin
      }
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ helper de login interactivo
    async function ensureToken() {
      const req = { scopes: window.EXCEL_UP_CFG.scopes };
      try {
        const result = await msal.acquireTokenSilent(req);
        return result.accessToken;
      } catch {
        const result = await msal.acquireTokenPopup(req);
        return result.accessToken;
      }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ env√≠a el formulario
    document.getElementById("f").onsubmit = async (e) => {
      e.preventDefault();
      const st = document.getElementById("status");
      st.textContent = "üîê Iniciando sesi√≥n‚Ä¶";

      try {
        const token = await ensureToken();
        st.textContent = "‚¨ÜÔ∏è Subiendo archivos‚Ä¶";

        const fd = new FormData(e.target);
        fd.append("token", token);           // se env√≠a al backend

        const r = await fetch("/api/process.py", { method: "POST", body: fd });
        if (!r.ok) throw new Error(await r.text());

        st.textContent = "‚¨áÔ∏è Descargando resultado‚Ä¶";
        const blob = await r.blob();
        const url  = URL.createObjectURL(blob);
        const a    = Object.assign(document.createElement("a"), {
          href: url,
          download: `TblInventario_actualizado_${fd.get("period")}.xlsx`
        });
        a.click(); URL.revokeObjectURL(url);
        st.textContent = "‚úÖ Terminado";
      } catch (err) {
        st.textContent = "‚ùå " + err.message;
        console.error(err);
      }
    };
  </script>
</body>
</html>
